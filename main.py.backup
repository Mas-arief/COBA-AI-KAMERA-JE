"""
SMART ATTENDANCE - PAKAI FACE-RECOGNITION
Install: pip install face-recognition opencv-python numpy pillow
"""

import cv2
import face_recognition
import numpy as np
import os
from datetime import datetime
import pickle
from pathlib import Path

# ========================================
# KONFIGURASI
# ========================================

FOTO_FOLDER = "foto_mahasiswa"
MODEL_FILE = "face_data.pkl"

# Data mahasiswa
data_mahasiswa = {
    "mahasiswa1.jpg": {"nama": "Budi Santoso", "nim": "2021001"},
    "mahasiswa2.jpg": {"nama": "Siti Aminah", "nim": "2021002"},
    "mahasiswa3.jpg": {"nama": "Ahmad Rizki", "nim": "2021003"}
}

# ========================================
# SETUP MEDIAPIPE
# ========================================

mp_face_detection = mp.solutions.face_detection
mp_face_mesh = mp.solutions.face_mesh
mp_drawing = mp.solutions.drawing_utils

print("="*50)
print("SMART ATTENDANCE SYSTEM (MediaPipe)")
print("="*50)

# ========================================
# FUNGSI EKSTRAK FITUR WAJAH
# ========================================

def extract_face_features(image, face_mesh):
    """Ekstrak landmark wajah sebagai fitur"""
    rgb_image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    results = face_mesh.process(rgb_image)
    
    if results.multi_face_landmarks:
        landmarks = results.multi_face_landmarks[0]
        # Ambil koordinat landmark penting (468 titik)
        features = []
        for landmark in landmarks.landmark:
            features.extend([landmark.x, landmark.y, landmark.z])
        return np.array(features)
    return None

def compare_faces(features1, features2, threshold=0.5):
    """Bandingkan dua fitur wajah"""
    if features1 is None or features2 is None:
        return False, 1.0
    
    # Hitung jarak Euclidean
    distance = np.linalg.norm(features1 - features2)
    # Normalisasi jarak
    similarity = 1 / (1 + distance)
    
    return similarity > threshold, distance

# ========================================
# LOAD ATAU TRAINING DATA
# ========================================

print("\nMemuat data wajah mahasiswa...")

known_features = []
known_names = []
known_nims = []

# Cek apakah sudah ada model tersimpan
if os.path.exists(MODEL_FILE):
    print("ğŸ“‚ Loading data dari file...")
    with open(MODEL_FILE, 'rb') as f:
        saved_data = pickle.load(f)
        known_features = saved_data['features']
        known_names = saved_data['names']
        known_nims = saved_data['nims']
    print(f"âœ“ Loaded {len(known_names)} mahasiswa")
else:
    print("ğŸ”„ Training model dari foto...")
    
    with mp_face_mesh.FaceMesh(
        static_image_mode=True,
        max_num_faces=1,
        min_detection_confidence=0.5
    ) as face_mesh:
        
        for filename, info in data_mahasiswa.items():
            filepath = os.path.join(FOTO_FOLDER, filename)
            
            if os.path.exists(filepath):
                image = cv2.imread(filepath)
                features = extract_face_features(image, face_mesh)
                
                if features is not None:
                    known_features.append(features)
                    known_names.append(info["nama"])
                    known_nims.append(info["nim"])
                    print(f"âœ“ {info['nama']} - {filename}")
                else:
                    print(f"âœ— Tidak ada wajah di: {filename}")
            else:
                print(f"âœ— File tidak ada: {filename}")
    
    # Simpan model
    if len(known_names) > 0:
        with open(MODEL_FILE, 'wb') as f:
            pickle.dump({
                'features': known_features,
                'names': known_names,
                'nims': known_nims
            }, f)
        print(f"\nğŸ’¾ Model tersimpan di: {MODEL_FILE}")

if len(known_names) == 0:
    print("\nâŒ TIDAK ADA DATA MAHASISWA!")
    exit()

print(f"\nâœ… Total {len(known_names)} mahasiswa terdaftar")
print("="*50)

# ========================================
# DETEKSI REAL-TIME
# ========================================

cap = cv2.VideoCapture(0)

if not cap.isOpened():
    print("âŒ Kamera tidak terdeteksi!")
    exit()

absensi_hari_ini = {}

print("\nğŸ¥ Kamera aktif!")
print("ğŸ“Œ Tekan 'q' untuk keluar")
print("ğŸ“Œ Tekan 's' untuk simpan absensi")
print("ğŸ“Œ Tekan 'r' untuk reset training\n")

with mp_face_detection.FaceDetection(
    min_detection_confidence=0.5
) as face_detection, \
     mp_face_mesh.FaceMesh(
    max_num_faces=5,
    min_detection_confidence=0.5,
    min_tracking_confidence=0.5
) as face_mesh:
    
    frame_counter = 0
    
    while True:
        ret, frame = cap.read()
        
        if not ret:
            print("âŒ Gagal mengambil frame")
            break
        
        frame_counter += 1
        rgb_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        
        # Deteksi wajah
        detection_results = face_detection.process(rgb_frame)
        
        if detection_results.detections and frame_counter % 10 == 0:
            # Ekstrak fitur dari frame
            mesh_results = face_mesh.process(rgb_frame)
            
            if mesh_results.multi_face_landmarks:
                for face_landmarks in mesh_results.multi_face_landmarks:
                    # Ekstrak fitur
                    features = []
                    for landmark in face_landmarks.landmark:
                        features.extend([landmark.x, landmark.y, landmark.z])
                    current_features = np.array(features)
                    
                    # Bandingkan dengan database
                    best_match = None
                    best_distance = float('inf')
                    
                    for i, known_feat in enumerate(known_features):
                        match, distance = compare_faces(current_features, known_feat, threshold=0.6)
                        if match and distance < best_distance:
                            best_distance = distance
                            best_match = i
                    
                    if best_match is not None:
                        name = known_names[best_match]
                        nim = known_nims[best_match]
                        confidence = (1 / (1 + best_distance)) * 100
                        
                        # Catat absensi
                        if nim not in absensi_hari_ini:
                            waktu = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                            absensi_hari_ini[nim] = {
                                "nama": name,
                                "waktu": waktu
                            }
                            print(f"âœ“ HADIR: {name} ({nim}) - {confidence:.1f}%")
        
        # Gambar deteksi di frame
        if detection_results.detections:
            for detection in detection_results.detections:
                bboxC = detection.location_data.relative_bounding_box
                ih, iw, _ = frame.shape
                x, y, w, h = int(bboxC.xmin * iw), int(bboxC.ymin * ih), \
                             int(bboxC.width * iw), int(bboxC.height * ih)
                
                cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 255, 0), 2)
        
        # Info di layar
        cv2.putText(frame, f"Hadir: {len(absensi_hari_ini)}/{len(known_names)}", 
                    (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
        
        cv2.putText(frame, "q=keluar | s=simpan | r=reset", 
                    (10, frame.shape[0] - 10), cv2.FONT_HERSHEY_SIMPLEX, 
                    0.5, (255, 255, 255), 1)
        
        cv2.imshow('Smart Attendance', frame)
        
        key = cv2.waitKey(1) & 0xFF
        
        if key == ord('q'):
            break
        elif key == ord('s'):
            print("\nğŸ’¾ Menyimpan...")
            break
        elif key == ord('r'):
            if os.path.exists(MODEL_FILE):
                os.remove(MODEL_FILE)
                print("\nğŸ”„ Model direset! Restart program.")
                break

# ========================================
# SIMPAN HASIL
# ========================================

cap.release()
cv2.destroyAllWindows()

print("\n" + "="*50)
print("REKAPITULASI ABSENSI")
print("="*50)

if len(absensi_hari_ini) == 0:
    print("Tidak ada yang hadir")
else:
    for nim, data in sorted(absensi_hari_ini.items()):
        print(f"âœ“ {data['nama']} ({nim}) - {data['waktu']}")

print("="*50)

# Simpan ke file
filename = f"absensi_{datetime.now().strftime('%Y-%m-%d_%H-%M')}.txt"
with open(filename, "w", encoding="utf-8") as f:
    f.write("="*50 + "\n")
    f.write("DAFTAR HADIR MAHASISWA\n")
    f.write("="*50 + "\n")
    f.write(f"Tanggal: {datetime.now().strftime('%d %B %Y')}\n\n")
    
    f.write("HADIR:\n")
    for nim, data in sorted(absensi_hari_ini.items()):
        f.write(f"  âœ“ {data['nama']} ({nim}) - {data['waktu']}\n")
    
    f.write(f"\nTotal: {len(absensi_hari_ini)}/{len(known_names)}\n")

print(f"\nâœ… Tersimpan: {filename}")